<!DOCTYPE HTML>
<html id="top" lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<meta name="theme-color" content="#142334">
		<title>cleanerr - Housekeeping! </title>
		<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
		<!-- Copyright (c) 2021-present, shi Blank
			 Licensed under the MIT license whose full text can be found at http://opensource.org/licenses/MIT -->
		<style>
			/*! minireset.css v0.0.3 | MIT License | github.com/jgthms/minireset.css */html,body,p,ol,ul,li,dl,dt,dd,blockquote,figure,fieldset,legend,textarea,pre,iframe,hr,h1,h2,h3,h4,h5,h6{margin:0;padding:0}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal}ul{list-style:none}button,input,select,textarea{margin:0}html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}img,embed,iframe,object,audio,video{height:auto;max-width:100%}iframe{border:0}table{border-collapse:collapse;border-spacing:0}td,th{padding:0;text-align:left}
			
			html	{scroll-behavior:smooth;}
			body, html	{-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-weight:normal; font-style:normal;}
			body	{background:#f2f2f2; font-family:sans-serif; font-size:1rem; line-height:1.5; color:#444;}
			body	{display:grid; height:100vh; grid-template-rows:auto 1fr auto;}
			h1		{font-size:4em; font-weight:normal; color:#1400ff;}
			h2		{font-size:2em; font-weight:normal;}
			h3		{font-size:1.3em; font-weight:bold;}
			a		{text-decoration:none;}
			p		{margin:0.5em 0;}
			img		{max-width:100%; height:auto;}
			.wrap	{background:#fff;}
			.head_wrap	{padding:2em 0 0 0; margin:0 auto;}
			.head_wrap.no_options	{padding-bottom:3em;}
			.info_wrap	{padding:2em 0 0 7px;}
			.foot_wrap,
			.table_wrap	{max-width:1280px; padding:2em 4em; margin:0 auto;}
			.table_wrap	{font-size:12px; line-height:1.5em;}
			.table_wrap.no_bottom .datatable-bottom	{display:none;}
			.legend_wrap{padding:2em 0;}
			table		{table-layout:fixed; overflow:hidden; overflow-wrap:break-word; word-wrap:break-word;}
			table.total_duplicates,
			table.legend	{width:100%;}
			table.total_duplicates tr:nth-child(2n+1),
			table.legend tr:nth-child(2n)	{background-color:#F8F8F8;}
			table.total_duplicates tr:nth-child(2n),
			table.legend tr:nth-child(2n+1) {background-color:#fff;}
			table.total_duplicates td,
			table.legend td,
			table.legend th {padding:4px 10px; border-top:1px solid #eee;}
			table.legend th {font-weight:normal;}
			table.legend th.legend_name	{width:25%;}
			table.total_duplicates tr:first-child td	{border:0;}
			table.total_duplicates td:nth-child(2n)		{width:82%;}	/*	legend description	*/
			table.legend td:nth-child(2n)	{width:80%;}	/*	legend description	*/
			#aid_errors   th:nth-child(2)	{width:10%;}	/*	count	*/
			#aid_errors   th:nth-child(3)	{width:70%;}	/*	datasets	*/
			#orgid_errors th:nth-child(2)	{width:10%;}	/*	count	*/
			#orgid_errors th:nth-child(3)	{width:70%;}	/*	datasets	*/
			#table_errors th:nth-child(3)	{width:25%;}	/*	error	*/
			#table_errors th:nth-child(4)	{width:40%;}	/*	url	*/
			#table_counts th:nth-child(3)	{width:15%;}	/*	type	*/
			#table_counts th:nth-child(4)	{width:10%;}	/*	num	*/
			#table_counts th:nth-child(5)	{width:40%;}	/*	url	*/
			#table_errors_counts th:nth-child(1)	{width:18%;}	/*	count	*/
			#table_errors_counts th:nth-child(3)	{width:50%;}	/*	description	*/
			#table_counts_counts th:nth-child(1)	{width:18%;}	/*	count	*/
			#table_counts_counts td	{text-transform:capitalize;}
			.foot_wrap	{font-size:14px;}
			.foot_cont,
			.foot_cont_right	{box-sizing:border-box; display:inline-block; padding-right:1em; width:70%; vertical-align:top;}
			.foot_cont_right	{width:30%; padding-right:0;}
			.foot_cont_right .foot_text 	{font-size:12px;}
			.foot_small	{font-size:12px;}
			.foot_bold	{font-weight:bold;}
			.foot_bold p{margin:1.5em 0;}
			span#date	{font-style:italic;}
			
			/*	Table style	*/
			table.datatable-table	{border-radius:4px; border-bottom:0;}
			
			/*	Table alternate rows highlight	*/
			.datatable-table tr:nth-child(2n)	{background-color:#F8F8F8;}
			.datatable-table tr:nth-child(2n+1)	{background-color:#fff;}
			
			/*	Table header	*/
			.datatable-sorter::before	{border-top:4px solid #fff; bottom:2px;}
			.datatable-sorter::after	{border-bottom:4px solid #fff; top:-4px;}
			.datatable-sorter::before,
			.datatable-sorter::after	{opacity:1;}
			.datatable-table > thead > tr > th	{background-color:#3744ff; color:#fff; text-transform:uppercase; font-size:10px;}
			.datatable-table > thead > tr > th:hover	{background-color:#5E68FF;}
			
			/*	Table footer	*/
			.datatable-wrapper.no-footer .datatable-container	{border:0;}
			.show_info .datatable-bottom > div:last-child	{float:left;}
						
			/*	Table grid	*/
			.datatable-table > tbody > tr > td,
			.datatable-table > tbody > tr > th,
			.datatable-table > tfoot > tr > td,
			.datatable-table > tfoot > tr > th,
			.datatable-table > thead > tr > td,
			.datatable-table > thead > tr > th	{padding:4px 10px; border-bottom:1px solid #eee;}
			
			/*	Table top bar	*/
			.datatable-top	{margin-top:-3em;}
			
			/*	Table dropdown	*/
			.datatable-selector {padding:2px 0px; margin-right:5px;}
			.datatable-dropdown {padding-bottom:1em;}
			
			/*	Table search bar	*/
			.datatable-top > div:first-child	{float:right;}
			.datatable-top > div:last-child		{padding-right:1em;}
			
			/*	Back to top link	*/
			a.top		{display:block; width:100%; padding:20px 0; text-align:center; font-size:12px; color:#444; cursor:pointer;}
			a.top:hover	{background-color:#F8F8F8;}
			
			/*	PHONES & STUFF
				============================================= */
				
			@media only screen and (-webkit-min-device-pixel-ratio: 1.5),
			only screen and (-o-min-device-pixel-ratio: 3/2),
			only screen and (min--moz-device-pixel-ratio: 1.5),
			only screen and (min-device-pixel-ratio: 1.5) {

			.head_wrap	{padding:1em; margin:0 auto; line-height:2em;}
			.foot_wrap	{padding:2em; font-size:12px;}
			.legend_wrap{padding:1em 0 2em 0;}
			.table_wrap	{padding:1vh; max-width:initial;}
			#aid_errors th,
			#orgid_errors th,
			#table_errors_counts th,
			#table_counts_counts th,
			#table_errors th,
			#table_counts th	{width:initial;}
			#aid_errors th:nth-child(2),
			#orgid_errors th:nth-child(2)	{width:25%; padding:4px 0px 4px 10px;}	/*	count	*/
			#table_counts th:nth-child(4)	{width:15%; padding:4px 0px 4px 10px;}	/*	num	*/
			#table_errors th:nth-child(4),
			#table_counts th:nth-child(5)	{width:20%;}	/*	url	*/
			#table_counts th:nth-child(3)	{width:20%;}
			#table_counts th:nth-child(2)	{width:15%;}
			#table_counts th:nth-child(1)	{width:25%;}
			#table_counts_counts th:nth-child(1),
			#table_errors_counts th:nth-child(1)	{width:25%;}
			table.total_duplicates td:nth-child(2n)	{width:75%;}
			#aid_errors th:nth-child(3),
			#orgid_errors th:nth-child(3)	{width:40%;}
			span#date	{display:block; padding-top:1em;}
			.head_wrap.no_options {padding-bottom:1em;}
				
			.datatable-top	{margin-top:-1em;}
			.datatable-top > div:first-child,
			.datatable-top > nav:last-child,
			.datatable-top > div:last-child,
			.datatable-bottom > nav:last-child,
			.datatable-bottom > div:last-child {float:none;}
			}
		</style>
		<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
		<script>
			/*	Modified for use. Thank you to Daniel Tillin - https://code.google.com/archive/p/csv-to-array/	*/
			csvToArray = function (str,o) {
				var od = {
					'fSep': ',',
					'rSep': '\n',
					'quot': '"',
					'head': false,
					'trim': false
				}
				if (o) {
					for (var i in od) {
						if (!o[i]) o[i] = od[i];
					}
				} else {
					o = od;
				}
				var a = [
					['']
				];
				for (var r = f = p = q = 0; p < str.length; p++) {
					switch (c = str.charAt(p)) {
					case o.quot:
						if (q && str.charAt(p + 1) == o.quot) {
							a[r][f] += o.quot;
							++p;
						} else {
							q ^= 1;
						}
						break;
					case o.fSep:
						if (!q) {
							if (o.trim) {
								a[r][f] = a[r][f].replace(/^\s\s*/, '').replace(/\s\s*$/, '');
							}
							a[r][++f] = '';
						} else {
							a[r][f] += c;
						}
						break;
					case o.rSep.charAt(0):
						if (!q && (!o.rSep.charAt(1) || (o.rSep.charAt(1) && o.rSep.charAt(1) == str.charAt(p + 1)))) {
							if (o.trim) {
								a[r][f] = a[r][f].replace(/^\s\s*/, '').replace(/\s\s*$/, '');
							}
							a[++r] = [''];
							a[r][f = 0] = '';
							if (o.rSep.charAt(1)) {
								++p;
							}
						} else {
							a[r][f] += c;
						}
						break;
					default:
						a[r][f] += c;
					}
				}
				if (o.head) {
					a.shift()
				}
				if (a[a.length - 1].length < a[0].length) {
					a.pop()
				}
				return a;
			}
		</script>
		<script>	/*	Download and import errors & Error Count */
			fetch("errors.csv")
			.then(response => response.text())
			.then(data => {
			fetch("http_codes.json")
			.then(response => response.json())
			.then(http_codes => {
				
				let lines=csvToArray(data)
				let header
				let datas=[]
				let counts={}
				let tableErrors=[]
				
				for (let line of lines)
				{					
					if (!header)
					{
						header=line
					}
					else
					{
						if (line.length!=1)
						{
							datas[datas.length]=line
							line[0]=`<a href="https://iatiregistry.org/dataset/${line[0]}" target="_blank">${line[0]}</a>`
							line[1]=`<a href="https://iatiregistry.org/publisher/${line[1]}" target="_blank">${line[1]}</a>`
							line[3]=`<a href="${line[3]}" target="_blank">${line[3]}</a>`
							
							let v = line[2]
							let aa = v.split(" ")
							
							if (aa[0]=="restored")
							{
								aa[1]="(number)"
							}
							
							v=aa.join(" ")
							counts[v] = (counts[v] || 0) + 1
						}							
					}
				}
								
				for (let error in counts)
				{
					let aa = error.split(" ")
					
					if (aa[0]=="curl:")
					{
						let code=aa[3]
						let it=http_codes[code] || ["Unknown Error","Description unknown. Please check the internet."]
						let response=it[0]
						let description=it[1]
						tableErrors[tableErrors.length] = [counts[error],error,`${code} ${response} : ${description}`]
					}
					else
					{
						if (aa[0]=="Converting")
						{
							tableErrors[tableErrors.length] = [counts[error],error,"These datasets have been converted to version 2.03 of the IATI Standard."]		
						}
						
						if (aa[0]=="dflat:")
						{
							tableErrors[tableErrors.length] = [counts[error],error,"There has been an error parsing these datasets."]		
						}
						
						if (aa[0]=="restored")
						{
							tableErrors[tableErrors.length] = [counts[error],error,"Due to current errors, previous successfully parsed files have been restored instead."]		
						}
					}	
				}
				
				tableErrors.sort(function(a,b)
				{
					return b[0] - a[0];
				})
				
				let table = new simpleDatatables.DataTable("#table_errors", {
					data: {
					  headings: header,
					  data: datas
					},
					labels: {
						perPage: "datasets per page",
						info: "Showing {start} to {end} of {rows} datasets",
					},
					perPageSelect: [15, 25, 50, 100],
					perPage: 15
				})
				
				let tableErrorCount = new simpleDatatables.DataTable("#table_errors_counts", {
					data: {
					  headings: ["dataset","error","description"],
					  data: tableErrors
					},
					labels: {
						perPage: "errors per page",
						info: "Showing {start} to {end} of {rows} errors",
					},
					perPageSelect: [15, 25, 50, 100],
					perPage: 15
				})
			})
			})
		</script>	
		<script>	/*	File type total count	*/
			fetch("counts.csv")
			.then(response => response.text())
			.then(data => {
				
				let lines=csvToArray(data)
				let header
				let datas=[]
				let counts={}
				let tableCounts=[]
				
				for (let line of lines)
				{
					if (!header)
					{
						header=line
					}
					else
					{
						if (line.length!=1)
						{
							datas[datas.length]=line
							line[0]=`<a href="https://iatiregistry.org/dataset/${line[0]}" target="_blank">${line[0]}</a>`
							line[1]=`<a href="https://iatiregistry.org/publisher/${line[1]}" target="_blank">${line[1]}</a>`
							line[4]=`<a href="${line[4]}" target="_blank">${line[4]}</a>`
							
							let v = line[2]
							let x = line[3]
							counts[v] = (counts[v] || 0) + parseInt(x)
						}							
					}
				}
												
				let table = new simpleDatatables.DataTable("#table_counts", {
					data: {
					  headings: header,
					  data: datas
					},
					labels: {
						perPage: "datasets per page",
						info: "Showing {start} to {end} of {rows} datasets",
					},
					perPageSelect: [15, 25, 50, 100],
					perPage: 15
				})
				
				for (let file in counts)
				{
					tableCounts[tableCounts.length] = [counts[file],file]
				}
				
				tableCounts.sort(function(a,b)
				{
					return b[0] - a[0];
				})
				
				let tableCountCount = new simpleDatatables.DataTable("#table_counts_counts", {
					data: {
					  headings: ["count","type"],
					  data: tableCounts
					},
					paging: false,
					searchable: false,
					layout: {
						top: "",
						bottom: ""
					}
				})
			})
		</script>
		<script>	/*	Duplicate organisation identifiers	*/
			fetch("organisation-identifiers.errors.json")
			.then(response => response.json())
			.then(data => {
				
				let datas=[]
				let header=["pid","count","datasets"]
				let total=0
				
				for (let id in data)
				{
					let aa=[]
					
					for (let line of data[id])
					{
						let ab=line.split("/")
						aa.push(`<a href="https://iatiregistry.org/dataset/${ab[0]}" target="_blank">${ab[0]}</a>`)
					}
					
					total = total + data[id].length - 1
					
					datas.push([id,data[id].length,aa.join(" , ")])
				}

				document.getElementById("total_pid_duplicates").innerHTML = total.toString();
				
				let table = new simpleDatatables.DataTable("#orgid_errors", {
					data: {
					  headings: header,
					  data: datas
					},
					labels: {
						perPage: "identifiers per page",
						info: "Showing {start} to {end} of {rows} org identifiers",
					},
					perPageSelect: [15, 25, 50, 100],
					perPage: 15
				})
				
			})
		</script>
		<script>	/*	Duplicate activity identifiers	*/
			fetch("activity-identifiers.errors.json")
			.then(response => response.json())
			.then(data => {
				
				let datas=[]
				let header=["aid","count","datasets"]
				let total=0
				
				for (let id in data)
				{
					let aa=[]
					
					for (let line of data[id])
					{
						let ab=line.split("/")
						aa.push(`<a href="https://iatiregistry.org/dataset/${ab[0]}" target="_blank">${ab[0]}</a>`)
					}
					
					total = total + data[id].length - 1
					
					datas.push([id,data[id].length,aa.join(" , ")])
				}
				
				document.getElementById("total_aid_duplicates").innerHTML = total.toString();
				
				let table = new simpleDatatables.DataTable("#aid_errors", {
					data: {
					  headings: header,
					  data: datas
					},
					labels: {
						perPage: "identifiers per page",
						info: "Showing {start} to {end} of {rows} activity identifiers",
					},
					perPageSelect: [15, 25, 50, 100],
					perPage: 15
				})
				
			})
		</script>
		<script>
			fetch("date.txt")
			.then(response => response.text())
			.then(data => {
				let d = data
				document.getElementById("date").innerHTML = "Last updated "+d.toString();
			})
		</script>
	</head>
	<body>
		<div class="table_wrap">
			<div class="head_wrap"><h2>Duplicate organisation identifiers</h2></div>
			<table id="orgid_errors"></table>
		</div>
		<div class="table_wrap">
			<div class="head_wrap"><h2>Duplicate activity identifiers</h2></div>
			<table id="aid_errors"></table>
		</div>
		<div class="table_wrap">
			<div class="head_wrap"><h2>Download and import errors</h2></div>
			<table id="table_errors"></table>
		</div>
		<div class="table_wrap show_info">
			<div class="head_wrap"><h2>Error count</h2></div>
			<table id="table_errors_counts"></table>
		</div>
		<div class="table_wrap no_bottom">
			<div class="head_wrap no_options"><h2>File type total count</h2></div>
			<table id="table_counts_counts"></table>
			<table class="total_duplicates">
				<tr><td><div id="total_pid_duplicates"></div></td><td>Total number of duplicate organisation identifiers</td></tr>
				<tr><td><div id="total_aid_duplicates"></div></td><td>Total number of duplicate activity identifiers</td></tr>
			</table>
			<div class="info_wrap">
				<div><b>Activities</b> refer to total number of activities that have been downloaded and parsed successfully during the nightly import. Includes duplicate data.</div>
				<div><b>Files</b> refer to total number of restored files due to current parsing errors during the nightly import.</div>
				<div><b>Organisations</b> refer to total number of organisations derived from the data. Includes duplicate data.</div>
			</div>
		</div>
		<div class="table_wrap">
			<div class="head_wrap"><h2>File type count per dataset</h2></div>
			<table id="table_counts"></table>
		</div>
		<div class="table_wrap">
			<div class="head_wrap"><h2>Legend</h2></div>
			<div class="legend_wrap">
				<table class="legend">
					<thead>
						<tr><th class="legend_name"><b>Dataset</b></th><th>IATI Registry dataset identifier (link opens in new window / tab)</th></tr>
					</thead>
					<tbody>
						<tr><td><b>Pub</b></td><td>IATI Registry publisher identifier (link opens in new window / tab)</td></tr>
						<tr><td><b>AID</b></td><td>IATI activity identifier</td></tr>
						<tr><td><b>PID</b></td><td>IATI organisation identifier</td></tr>
						<tr><td><b>Type</b></td><td>File type can be activity or organisation</td></tr>
						<tr><td><b>Count</b></td><td>Total number of instances counted</td></tr>
						<tr><td><b>Num</b></td><td>Total number of activities or organisations in the dataset</td></tr>
						<tr><td><b>Error</b></td><td>Error messages encountered during import</td></tr>
						<tr><td><b>Description</b></td><td>Verbose description of error</td></tr>
						<tr><td><b>Url</b></td><td>Link to publisher provided data source (link opens in new window / tab)</td></tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="wrap">
			<div class="foot_wrap">
				<div class="foot_cont">
					<div class="foot_bold"><p>About</p></div>
					<div class="foot_text">
						Cleanerr converts the logs from <a href="https://github.com/xriss/dataiati">DataIATI</a> and displays them as tables.
					</div>
					<div class="foot_text">
						These logs are also available as csv files: [<a href="https://raw.githubusercontent.com/notshi/cleanerr/main/errors.csv">Download Errors</a>] [<a href="https://raw.githubusercontent.com/notshi/cleanerr/main/counts.csv">Download Counts</a>]
					</div>
					<div class="foot_text">
						<p>Logs are updated daily. <span id="date"></span></p>
					</div>
					<div class="foot_bold"><p><a href="http://github.com/notshi/cleanerr">Cleanerr is on Github</a></p></div>
					<div class="foot_small">Project by Wetgenes, 2021-present</div>
				</div><div class="foot_cont_right">
					<div class="foot_bold"><p>Other tools</p></div>
					<div class="foot_text"><a href="http://d-preview.codeforiati.org/">d-preview</a></div>
					<div class="foot_text"><p><a href="https://notshi.github.io/IATIswitcheroo/">IATI Switcheroo</a></p></div>
					<div class="foot_text"><a href="https://xriss.github.io/freechange-charts/">Freechange</a></div>
					<div class="foot_text"><p><a href="https://notshi.github.io/cleanerr">Cleanerr</a></p></div>
					<div class="foot_text"><p><a href="https://xriss.github.io/D-Portal-Logs/">d-portal logs</a></p></div>
				</div>
			</div>
			<a href="#top" class="top">BACK TOP</a>
		</div>
	</body>
</html>
